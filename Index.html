<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
      :root {
        --bg-body: #f4f6f9;
        --card-bg: #ffffff;
        --text-primary: #1a1f36;
        --text-secondary: #697386;
        
        /* Colores del Semáforo */
        --nav-red: #D92828;      /* Crítico > 1 */
        --nav-yellow: #d97706;   /* Precaución = 1 (Ocre oscurito para contraste) */
        --nav-green: #15803d;    /* OK = 0 */
      }

      body {
        background-color: var(--bg-body);
        font-family: 'Inter', sans-serif;
        color: var(--text-primary);
        transition: background-color 0.5s;
      }

      /* Navbar con transición suave de color */
      .navbar {
        background-color: var(--nav-green); /* Color inicial */
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        padding: 0.8rem 1rem;
        transition: background-color 0.8s ease-in-out;
      }
      
      /* Clases para cambiar el color con JS */
      .bg-estado-critico { background-color: var(--nav-red) !important; }
      .bg-estado-alerta { background-color: var(--nav-yellow) !important; }
      .bg-estado-ok { background-color: var(--nav-green) !important; }

      .navbar-brand {
        font-weight: 800; font-size: 1.2rem; letter-spacing: 0.5px; color: white !important;
        text-transform: uppercase;
      }

      /* Botón de Sonido */
      .btn-sound {
        background: rgba(255,255,255,0.2); border: none; color: white;
        border-radius: 50%; width: 35px; height: 35px; display: flex;
        align-items: center; justify-content: center; cursor: pointer;
        transition: all 0.2s;
      }
      .btn-sound:hover { background: rgba(255,255,255,0.4); transform: scale(1.1); }
      .sound-active { background: #fff; color: var(--nav-green); } /* Se pone blanco al activar */

      /* Indicadores */
      .live-indicator {
        display: inline-block; width: 10px; height: 10px; background-color: #fff;
        border-radius: 50%; margin-right: 6px; animation: pulse-white 2s infinite;
      }
      @keyframes pulse-white {
        0% { transform: scale(0.95); opacity: 0.7; }
        50% { transform: scale(1.1); opacity: 1; box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        100% { transform: scale(0.95); opacity: 0.7; }
      }

      /* Loader interno */
      .sync-badge {
        background-color: rgba(255, 255, 255, 0.25); color: white; padding: 4px 12px;
        border-radius: 15px; font-size: 0.8rem; display: flex; align-items: center; gap: 6px;
        opacity: 0; transition: opacity 0.3s;
      }
      .sync-badge.visible { opacity: 1; }

      /* Tarjetas */
      .card-solicitud {
        background: var(--card-bg); border: none; border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: transform 0.25s;
        margin-bottom: 20px; overflow: hidden; position: relative;
      }
      .card-solicitud:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.12); }

      .status-line { position: absolute; left: 0; top: 0; bottom: 0; width: 6px; }
      .border-sin-gestion { background-color: #D92828; }
      .border-pendiente { background-color: #f59e0b; }

      .card-body { padding: 1.25rem 1.25rem 1.25rem 1.5rem; }
      
      .card-header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
      .ticket-id { font-weight: 700; font-size: 1.1rem; color: var(--text-primary); }
      
      .badge-custom { font-size: 0.7rem; font-weight: 700; padding: 5px 10px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
      .bg-red-subtle { background-color: #fee2e2; color: #991b1b; }
      .bg-orange-subtle { background-color: #fef3c7; color: #b45309; }

      .data-row { display: flex; margin-bottom: 6px; font-size: 0.9rem; color: var(--text-secondary); }
      .data-row i { width: 20px; text-align: center; margin-right: 8px; color: #94a3b8; }
      .data-value { color: var(--text-primary); font-weight: 500; }

      .alert-novedad {
        margin-top: 10px; background-color: #fef2f2; border-left: 3px solid #ef4444;
        padding: 8px 12px; font-size: 0.85rem; color: #b91c1c;
      }
      
      .card-footer-custom {
        margin-top: 12px; padding-top: 10px; border-top: 1px solid #f1f5f9;
        font-size: 0.8rem; color: #64748b; display: flex; justify-content: space-between;
      }
    </style>
  </head>
  <body>
    
    <nav id="main-navbar" class="navbar fixed-top">
      <div class="container-fluid">
        
        <div class="d-flex align-items-center gap-3">
          <span class="navbar-brand">
            <i class="bi bi-shield-lock-fill me-2"></i>G4S MONITOR
          </span>
          <div id="sync-status" class="sync-badge">
             <div class="spinner-border spinner-border-sm text-light" style="width: 0.8rem; height: 0.8rem;" role="status"></div>
             <span>Sync</span>
          </div>
        </div>

        <div class="d-flex align-items-center gap-3">
          
          <button id="btn-sound" class="btn-sound" onclick="toggleSound()" title="Activar/Desactivar Alerta Sonora">
            <i id="icon-sound" class="bi bi-volume-mute-fill"></i>
          </button>

          <div class="text-white small text-end">
            <div class="d-flex align-items-center justify-content-end mb-1">
              <span class="live-indicator"></span>
              <span class="fw-bold">EN VIVO</span>
            </div>
            <div id="clock" style="font-family: monospace; opacity: 0.9;">--:--:--</div>
          </div>
        </div>
      </div>
    </nav>

    <div class="container-fluid" style="margin-top: 80px; max-width: 1600px;">
      
      <div class="section-title mb-4">
        <span class="text-secondary fw-bold small text-uppercase ls-1">
          <i class="bi bi-list-task me-1"></i> Panel de Control
        </span>
      </div>

      <div id="contenedor-prioritario" class="row"></div>
      
      <div id="mensaje-vacio" class="text-center py-5 d-none">
        <div style="font-size: 5rem; color: #dcfce7; margin-bottom: 1rem;">
          <i class="bi bi-check-circle-fill" style="color: #22c55e;"></i>
        </div>
        <h3 class="fw-bold text-success">Todo Operativo</h3>
        <p class="text-muted">No hay servicios pendientes ni sin gestión para hoy.</p>
      </div>

    </div>

  
<audio id="alerta-audio" preload="auto">
  <source src="https://cdn.freesound.org/previews/316/316847_4939433-lq.mp3" type="audio/mpeg">
</audio>



    <script>
      const REFRESH_RATE = 10000; 
      let soundEnabled = false;
      let previousIds = new Set(); // Memoria para saber qué es nuevo

      function iniciarCiclo() {
        cargarDatos();
        setInterval(cargarDatos, REFRESH_RATE);
        setInterval(actualizarReloj, 1000);
      }

      // --- Lógica del Sonido ---
function toggleSound() {
  soundEnabled = !soundEnabled;

  const btn = document.getElementById('btn-sound');
  const icon = document.getElementById('icon-sound');
  const audio = document.getElementById('alerta-audio');

  if (soundEnabled) {
    btn.classList.add('sound-active');
    icon.className = 'bi bi-volume-up-fill';

    // Desbloqueo de audio con gesto del usuario (click)
    audio.volume = 0;               // silencio
    audio.currentTime = 0;
    audio.play()
      .then(() => {
        audio.pause();
        audio.currentTime = 0;
        audio.volume = 1;           // vuelve a volumen normal
      })
      .catch(err => console.log("Audio unlock blocked:", err));

  } else {
    btn.classList.remove('sound-active');
    icon.className = 'bi bi-volume-mute-fill';
  }
}


function playAlert() {
  if (!soundEnabled) return;

  const audio = document.getElementById('alerta-audio');
  audio.pause();
  audio.currentTime = 0;
  audio.play().catch(e => console.log("Error audio:", e));
}


      function cargarDatos() {
        document.getElementById('sync-status').classList.add('visible');
        google.script.run
          .withSuccessHandler(pintarPantalla)
          .withFailureHandler(mostrarError)
          .obtenerDatos();
      }

      function pintarPantalla(jsonString) {
        setTimeout(() => document.getElementById('sync-status').classList.remove('visible'), 600);
        
        const datos = JSON.parse(jsonString);
        const divPrioritario = document.getElementById('contenedor-prioritario');
        const msgVacio = document.getElementById('mensaje-vacio');
        const navbar = document.getElementById('main-navbar');

        // 1. LOGICA DEL SEMÁFORO (NAVBAR)
        const cantidad = datos.length;
        
        // Reset de clases
        navbar.classList.remove('bg-estado-critico', 'bg-estado-alerta', 'bg-estado-ok');

        if (cantidad === 0) {
          navbar.classList.add('bg-estado-ok'); // Verde
          msgVacio.classList.remove('d-none');
          divPrioritario.innerHTML = '';
        } else {
          msgVacio.classList.add('d-none');
          
          if (cantidad === 1) {
            navbar.classList.add('bg-estado-alerta'); // Amarillo Ocre
          } else {
            navbar.classList.add('bg-estado-critico'); // Rojo G4S
          }

          // 2. LOGICA DE SONIDO (Detectar nuevos IDs)
          const currentIds = new Set(datos.map(d => d.ID_SOLICITUD));
          
          // Si hay algún ID nuevo que no estaba antes...
          const hayNuevos = datos.some(d => !previousIds.has(d.ID_SOLICITUD));
          
          // Solo sonar si hay nuevos Y no es la primera carga (para que no suene al refrescar página)
          if (hayNuevos && previousIds.size > 0) {
            playAlert();
          }

          // Actualizar memoria
          previousIds = currentIds;

          // Renderizado
          let html = '';
          // Ordenar: SIN GESTION primero
          datos.sort((a, b) => {
             const esA = a['ESTADO'].toString().includes('SIN GESTION');
             const esB = b['ESTADO'].toString().includes('SIN GESTION');
             return esB - esA; 
          });

          datos.forEach(fila => html += crearTarjeta(fila));
          divPrioritario.innerHTML = html;
        }
      }

      function crearTarjeta(datos) {
        const estado = (datos['ESTADO'] || '').toString();
        let colorLinea = 'border-pendiente';
        let badgeClass = 'bg-orange-subtle';
        let badgeText = 'PENDIENTE';

        if (estado.includes('SIN GESTION')) {
            colorLinea = 'border-sin-gestion';
            badgeClass = 'bg-red-subtle';
            badgeText = 'SIN GESTIÓN';
        }

        return `
          <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
            <div class="card-solicitud">
              <div class="status-line ${colorLinea}"></div>
              <div class="card-body">
                <div class="card-header-flex">
                  <div class="ticket-id"><i class="bi bi-ticket-perforated me-2 text-muted"></i>${datos['ID_SOLICITUD'] || '--'}</div>
                  <div class="badge-custom ${badgeClass}">${badgeText}</div>
                </div>
                <div class="data-row"><i class="bi bi-building"></i><span class="data-value">${datos['NOMBRE'] || datos['CLIENTE'] || '---'}</span></div>
                <div class="data-row"><i class="bi bi-geo-alt"></i><span class="text-truncate" style="max-width: 90%;">${datos['DIRECCION'] || '---'}</span></div>
                <div class="data-row"><i class="bi bi-crosshair"></i><span>${datos['MOTIVO_SERVICIO'] || '---'}</span></div>
                ${datos['NOVEDAD'] ? `<div class="alert-novedad"><i class="bi bi-exclamation-circle-fill me-1"></i> <strong>NOVEDAD:</strong> ${datos['NOVEDAD']}</div>` : ''}
                <div class="card-footer-custom">
                  <div>${datos['FECHA_SOLICITUD'] || ''}</div>
                  <div><i class="bi bi-clock me-1"></i>${datos['HORA_SOLICITUD'] || '--:--'}</div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function mostrarError(e) { console.error(e); }
      function actualizarReloj() {
        document.getElementById('clock').innerText = new Date().toLocaleTimeString();
      }

      window.onload = iniciarCiclo;
    </script>
  </body>
</html>
